# predict_new_samples.py

import pandas as pd
import pickle
import os
import sklearn


def scan(extracted_features_data=None):
    # Load the model
    with open('model/random_forest_model.pkl', 'rb') as file:
        random_forrest_model = pickle.load(file)

    # Check if the selected features file exists
    selected_features_path = 'model/Selected Features.pkl'
    print(f"Loading selected features from {selected_features_path}")
    if not os.path.exists(selected_features_path):
        print(f"Error: '{selected_features_path}' file not found.")
        exit(1) 

    # Load the selected features
    with open(selected_features_path, 'rb') as file:
        selected_features = pickle.load(file)
    # print(f"Loaded selected features: {selected_features.tolist()}")

    # Load the extracted features from the CSV file
    extracted_features_file = 'model/extracted_features.csv'
    if not os.path.exists(extracted_features_file):
        print(f"Error: '{extracted_features_file}' file not found.")
        exit(1)

    # Load the extracted features from the CSV file
    if extracted_features_data is None:
        features_file = 'extracted_features.csv'
        if not os.path.exists(features_file):
            print(f"Error: '{features_file}' file not found. Please ensure the file exists in the correct directory.")
            return
        new_data = pd.read_csv(features_file)
    else:
        new_data = extracted_features_data

    # Ensure extracted_features_data contains expected features
    missing_features = set(selected_features) - set(new_data.columns)
    missing_features_list = []
    if missing_features:
        print(f"Warning: The following expected features are missing in the new data: {missing_features}")
        missing_features_list = list(missing_features)

    # Filter the extracted_features_data to only contain the columns expected by the model
    #extracted_features_data_filtered = extracted_features_data.reindex(columns=selected_features).fillna(0)
    new_data_numeric = new_data.reindex(columns=selected_features).fillna(0)

    # Make classification_results if there are rows available
    if not new_data_numeric.empty:
        classification_results = random_forrest_model.predict(new_data_numeric)

        probabilities = random_forrest_model.predict_proba(new_data_numeric)

        # Map classification_results to labels
        prediction_labels = ['Malicious' if pred == 0 else 'Benign' for pred in classification_results]

        # Extract probabilities for the predicted class
        prediction_certainty = [max(prob) for prob in probabilities]

        # Output results
        results = pd.DataFrame({
            'Name': new_data['Name'],
            'md5': new_data['md5'],
            'Prediction': prediction_labels,
            'Probability': prediction_certainty
        })
        print(results)
    else:
        print("No valid data available for prediction.")

    return results, missing_features_list

if __name__ == "__main__":
    scan()