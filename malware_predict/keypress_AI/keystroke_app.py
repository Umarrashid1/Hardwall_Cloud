from flask import Flask, request, jsonify
import os
from predict import preprocess_data, nofile_preprocess_data, model, scaler
import pandas as pd
from io import StringIO
PORT = int(os.environ.get('PORT', 5300))
app = Flask(__name__)
app.config['MAX_CONTENT_LENGTH'] = 100 * 1024 * 1024  # 16 MB limit

@app.route('/', methods=['POST'])
def analyze_keystrokes():
    data = request.data

    # I Just made a bunch of nested try/except blocks out of laziness
    # fix this later
    try:
        df = pd.read_json(data)
        chunks = nofile_preprocess_data(df, scaler)
    except pd.errors.ParserError:
        try:
            df = pd.read_json(StringIO(data.decode('utf-8')))
            chunks = nofile_preprocess_data(df, scaler)
        except pd.errors.ParserError:
            try:
                csv_file = StringIO(data.decode('utf-8'))
                chunks = preprocess_data(csv_file, scaler)
            except pd.errors.ParserError:
                return jsonify({'error': 'Invalid JSON data'}), 400
      
    try:
        predictions = model.predict(chunks).flatten()
        predicted_labels = (predictions > 0.5).astype(int)
        predictions_df = pd.DataFrame({'prediction': predicted_labels})
        results = predictions_df.to_json()
    except Exception as e:
        return jsonify({'error': str(e)}), 400
    
    return results